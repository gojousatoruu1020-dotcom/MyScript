local lp = game:GetService("Players").LocalPlayer
local runService = game:GetService("RunService")

-- UIクリーニング
for _, v in pairs(lp:WaitForChild("PlayerGui"):GetChildren()) do
    if v.Name:find("Baftime") then v:Destroy() end
end

local sg = Instance.new("ScreenGui", lp.PlayerGui)
sg.Name = "BaftimeV107"
sg.ResetOnSpawn = false
sg.DisplayOrder = 999999

local st = { jump = false, esp = false, grab = false, chasing = false, mini = false, subVisible = false, subLock = false }
local targetPlayer = nil

-- --- 1. メインメニュー ---
local main = Instance.new("Frame", sg)
main.Size = UDim2.new(0, 140, 0, 180)
main.Position = UDim2.new(0, 30, 0.4, 0)
main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
main.Active = true
main.Draggable = true 
Instance.new("UICorner", main)

local minBtn = Instance.new("TextButton", main)
minBtn.Size = UDim2.new(0, 25, 0, 25)
minBtn.Position = UDim2.new(1, -30, 0, 5)
minBtn.Text = "ー"
minBtn.ZIndex = 100
Instance.new("UICorner", minBtn)

local content = Instance.new("Frame", main)
content.Size = UDim2.new(1, 0, 1, -40)
content.Position = UDim2.new(0, 0, 0, 35)
content.BackgroundTransparency = 1
local list = Instance.new("UIListLayout", content)
list.HorizontalAlignment = "Center"
list.Padding = UDim.new(0, 6)

local function createBtn(txt, col)
    local b = Instance.new("TextButton", content)
    b.Size = UDim2.new(0, 120, 0, 32)
    b.Text = txt
    b.BackgroundColor3 = col
    b.TextColor3 = Color3.new(1, 1, 1)
    b.ZIndex = 100
    Instance.new("UICorner", b)
    return b
end

local b_sub  = createBtn("追跡メニュー: 出す", Color3.fromRGB(0, 80, 40))
local b_esp  = createBtn("透視表示: OFF", Color3.fromRGB(50, 50, 50))
local b_grab = createBtn("自動掴み: OFF", Color3.fromRGB(80, 20, 20))
local b_jump = createBtn("無限跳躍: OFF", Color3.fromRGB(50, 50, 50))

-- --- 2. 独立追跡ボタン ---
local s_chase = Instance.new("TextButton", sg)
s_chase.Size = UDim2.new(0, 75, 0, 75)
s_chase.Position = UDim2.new(1, -120, 1, -220)
s_chase.BackgroundColor3 = Color3.fromRGB(0, 150, 80)
s_chase.Text = "CHASE"
s_chase.TextColor3 = Color3.new(1, 1, 1)
s_chase.Visible = false
s_chase.Draggable = true
s_chase.ZIndex = 200
Instance.new("UICorner", s_chase).CornerRadius = UDim.new(0.5, 0)

local s_lock = Instance.new("TextButton", sg)
s_lock.Size = UDim2.new(0, 65, 0, 28)
s_lock.BackgroundColor3 = Color3.fromRGB(200, 50, 0)
s_lock.Text = "固定: OFF"
s_lock.TextColor3 = Color3.new(1, 1, 1)
s_lock.Visible = false
s_lock.ZIndex = 200
Instance.new("UICorner", s_lock)

runService.RenderStepped:Connect(function()
    s_lock.Position = s_chase.Position + UDim2.new(0, 5, 0, 80)
end)

-- --- 機能クリックイベント ---
b_sub.MouseButton1Click:Connect(function()
    st.subVisible = not st.subVisible
    s_chase.Visible = st.subVisible
    s_lock.Visible = st.subVisible
    b_sub.Text = st.subVisible and "追跡メニュー: 消す" or "追跡メニュー: 出す"
end)

s_lock.MouseButton1Click:Connect(function()
    st.subLock = not st.subLock
    s_chase.Draggable = not st.subLock
    s_lock.Text = st.subLock and "固定: ON" or "固定: OFF"
    s_lock.BackgroundColor3 = st.subLock and Color3.fromRGB(0, 120, 200) or Color3.fromRGB(200, 50, 0)
end)

s_chase.MouseButton1Click:Connect(function()
    if st.chasing then st.chasing = false targetPlayer = nil s_chase.Text = "CHASE"
    else
        local plrs = {}
        for _, p in pairs(game.Players:GetPlayers()) do 
            if p ~= lp and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then table.insert(plrs, p) end
        end
        if #plrs > 0 then targetPlayer = plrs[math.random(1, #plrs)] st.chasing = true s_chase.Text = "STOP" end
    end
end)

b_esp.MouseButton1Click:Connect(function() st.esp = not st.esp b_esp.Text = st.esp and "透視: ON" or "透視: OFF" b_esp.BackgroundColor3 = st.esp and Color3.new(0,0.5,0) or Color3.fromRGB(50,50,50) end)
b_grab.MouseButton1Click:Connect(function() st.grab = not st.grab b_grab.Text = st.grab and "掴み: ON" or "掴み: OFF" b_grab.BackgroundColor3 = st.grab and Color3.new(0.6,0,0) or Color3.fromRGB(80,20,20) end)
b_jump.MouseButton1Click:Connect(function() st.jump = not st.jump b_jump.Text = st.jump and "跳躍: ON" or "跳躍: OFF" b_jump.BackgroundColor3 = st.jump and Color3.new(0,0.4,0) or Color3.fromRGB(50,50,50) end)

minBtn.MouseButton1Click:Connect(function()
    st.mini = not st.mini
    content.Visible = not st.mini
    main.Size = st.mini and UDim2.new(0, 140, 0, 35) or UDim2.new(0, 140, 0, 180)
end)

-- --- メインループ (全機能の心臓部) ---
runService.Heartbeat:Connect(function()
    -- 1. 追跡
    if st.chasing and targetPlayer and targetPlayer.Character and lp.Character then
        local hrp = lp.Character:FindFirstChild("HumanoidRootPart")
        local t_hrp = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
        if hrp and t_hrp then
            hrp.Velocity = Vector3.zero
            hrp.CFrame = hrp.CFrame:Lerp(t_hrp.CFrame * CFrame.new(0,0,4), 0.4)
        end
    end

    -- 2. 透視 (ESP)
    for _, p in pairs(game.Players:GetPlayers()) do
        if p ~= lp and p.Character and p.Character:FindFirstChild("Head") then
            local head = p.Character.Head
            local esp = head:FindFirstChild("BaftimeESP")
            if st.esp then
                if not esp then
                    esp = Instance.new("BillboardGui", head)
                    esp.Name = "BaftimeESP"
                    esp.Size = UDim2.new(0,80,0,40)
                    esp.AlwaysOnTop = true
                    local t = Instance.new("TextLabel", esp)
                    t.Size = UDim2.new(1,0,1,0)
                    t.BackgroundTransparency = 1
                    t.TextColor3 = Color3.new(1,1,0)
                    t.TextSize = 12
                    Instance.new("Highlight", p.Character).Name = "BaftimeH"
                end
                local d = math.floor((lp.Character:GetPivot().Position - head.Position).Magnitude)
                esp.TextLabel.Text = p.DisplayName .. "\n" .. d .. "m"
            else
                if esp then esp:Destroy() end
                if p.Character:FindFirstChild("BaftimeH") then p.Character.BaftimeH:Destroy() end
            end
        end
    end

    -- 3. 自動掴み
    if st.grab and lp.Character then
        for _, v in pairs(workspace:GetDescendants()) do
            if v:IsA("ProximityPrompt") and (lp.Character:GetPivot().Position - v.Parent.Position).Magnitude < 18 then
                v.HoldDuration = 0
                if fireproximityprompt then fireproximityprompt(v) else v:InputHoldBegin() v:InputHoldEnd() end
            end
        end
    end

    -- 4. 無限跳躍
    if st.jump and lp.Character and lp.Character:FindFirstChild("Humanoid") then
        if lp.Character.Humanoid.Jump then
            lp.Character.HumanoidRootPart.Velocity = Vector3.new(lp.Character.HumanoidRootPart.Velocity.X, 20, lp.Character.HumanoidRootPart.Velocity.Z)
        end
    end
end)
